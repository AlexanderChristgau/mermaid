

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Simple example &mdash; mermaid 0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="mermaid 0.1 documentation" href="../index.html"/>
        <link rel="next" title="TODOs" href="todos.html"/>
        <link rel="prev" title="Parameters" href="parameters.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> mermaid
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Notes</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="howto_own_registration.html">How to write your own registration model</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="parameters.html">Parameters</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Simple example</a></li>
<li class="toctree-l1"><a class="reference internal" href="todos.html">TODOs</a></li>
</ul>
<p class="caption"><span class="caption-text">Package Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../custom_optimizers.html">Custom optimizers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../custom_pytorch_extensions.html">Custom pyTorch extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example_generation.html">Example generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../finite_differences.html">Finite differences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../forward_models.html">Forward models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../image_sampling.html">Image sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model_factory.html">Model factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../module_parameters.html">Parameter module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multiscale_optimizer.html">Multiscale optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../registration_networks.html">Registration networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../regularizer_factory.html">Regularizer factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rungekutta_integrators.html">Runge-Kutta integrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../similarity_measure_factory.html">Similarity measure factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../smoother_factory.html">Smoother factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stn.html">Spatial transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../utils.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../viewers.html">Viewers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualize_registration_results.html">Visualize registration results</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">mermaid</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Simple example</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/notes/simple_example.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="simple-example">
<h1>Simple example<a class="headerlink" href="#simple-example" title="Permalink to this headline">¶</a></h1>
<p>This is a very simple example demonstrating how to use <em>mermaid</em>. This example is also available as
<em>testMinimalRegistration.py</em>.</p>
<p>To start off we import some important modules. First the pyTorch modules and numpy.</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="c1"># first do the torch imports</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.autograd</span> <span class="k">import</span> <span class="n">Variable</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
<p>Next let’s import some of the <em>mermaid</em> modules contained in the <em>pyreg</em> directory</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">set_pyreg_paths</span>                  <span class="c1"># import the required paths</span>
<span class="kn">import</span> <span class="nn">pyreg.example_generation</span> <span class="k">as</span> <span class="nn">eg</span>   <span class="c1"># load the module to generate examples</span>
<span class="kn">import</span> <span class="nn">pyreg.module_parameters</span> <span class="k">as</span> <span class="nn">pars</span>  <span class="c1"># load the module to support parameters</span>
<span class="kn">import</span> <span class="nn">pyreg.multiscale_optimizer</span> <span class="k">as</span> <span class="nn">MO</span> <span class="c1"># load the optimizer module (which also supports single scale optimization)</span>
</pre></div>
</div>
<p>Now let’s choose a model, specify if it uses a map for the solution (i.e., warps the source image via a map
instead of solving directly an advection equation for an image), specify the desired dimension (can be 1, 2, or 3 –
play around with it yourself), and pick a maximum number of iterations for the solver. We also create an empty
parameter structure, so that <em>mermaid</em> can keep track of the parameters used. These can be written out layer by using
<code class="xref py py-meth docutils literal"><span class="pre">pars.write_JSON()</span></code>, but we ignore this for this simple example.</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">modelName</span> <span class="o">=</span> <span class="s1">&#39;lddmm_shooting_map&#39;</span>
<span class="n">useMap</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">nrOfIterations</span> <span class="o">=</span> <span class="mi">500</span> <span class="c1"># number of iterations for the optimizer</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">pars</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</pre></div>
</div>
<p>Now let’s create some example data, including variables holding the image size (sz) and spacing information.
In reality, of course, you would simply load your own data, which should already come with spacing information
and size information (size is in BCXYZ format: batch size, number of channels, X, Y, and Z coordinates; or only X
coordinates in 1D or X and Y coordinates in 2D).</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">szEx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="mi">50</span><span class="p">,</span> <span class="n">dim</span> <span class="p">)</span>         <span class="c1"># size of the desired images: (sz)^dim</span>
<span class="n">I0</span><span class="p">,</span><span class="n">I1</span><span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">CreateSquares</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="o">.</span><span class="n">create_image_pair</span><span class="p">(</span><span class="n">szEx</span><span class="p">,</span><span class="n">params</span><span class="p">)</span> <span class="c1"># create a default image size with two sample squares</span>
<span class="n">sz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">I0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">spacing</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">::]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># the first two dimensions are batch size and number of image channels</span>
</pre></div>
</div>
<p>To be able to communicate with pyTorch’s autograd functionality, let’s make these images pyTorch variables.</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="c1"># create the source and target image as pyTorch variables</span>
<span class="n">ISource</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span> <span class="n">I0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="n">ITarget</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span> <span class="n">I1</span> <span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</pre></div>
</div>
<p>Now we are ready to set up the optimizer and to optimize. By default some visual output will be created.
Close each figure for the optimizer to advance.</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">so</span> <span class="o">=</span> <span class="n">MO</span><span class="o">.</span><span class="n">SingleScaleRegistrationOptimizer</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">useMap</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
<span class="n">so</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="n">modelName</span><span class="p">)</span>

<span class="n">so</span><span class="o">.</span><span class="n">set_number_of_iterations</span><span class="p">(</span><span class="n">nrOfIterations</span><span class="p">)</span>

<span class="n">so</span><span class="o">.</span><span class="n">set_source_image</span><span class="p">(</span><span class="n">ISource</span><span class="p">)</span>
<span class="n">so</span><span class="o">.</span><span class="n">set_target_image</span><span class="p">(</span><span class="n">ITarget</span><span class="p">)</span>

<span class="c1"># and now do the optimization</span>
<span class="n">so</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
</pre></div>
</div>
<p>That’s it. Pretty easy, no?</p>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="todos.html" class="btn btn-neutral float-right" title="TODOs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="parameters.html" class="btn btn-neutral" title="Parameters" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Marc Niethammer.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>