

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>registration_networks &mdash; mermaid 0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="mermaid 0.1 documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> mermaid
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../notes/howto_own_registration.html">How to write your own registration model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/parameters.html">Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/simple_example.html">Simple example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/todos.html">TODOs</a></li>
</ul>
<p class="caption"><span class="caption-text">Package Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../custom_optimizers.html">Custom optimizers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../custom_pytorch_extensions.html">Custom pyTorch extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example_generation.html">Example generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../finite_differences.html">Finite differences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../forward_models.html">Forward models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../image_sampling.html">Image sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model_factory.html">Model factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../module_parameters.html">Parameter module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multiscale_optimizer.html">Multiscale optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../registration_networks.html">Registration networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../regularizer_factory.html">Regularizer factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rungekutta_integrators.html">Runge-Kutta integrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../similarity_measure_factory.html">Similarity measure factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../smoother_factory.html">Smoother factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stn.html">Spatial transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../utils.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../viewers.html">Viewers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualize_registration_results.html">Visualize registration results</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">mermaid</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>registration_networks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for registration_networks</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Defines different registration methods as pyTorch networks.</span>
<span class="sd">Currently implemented:</span>
<span class="sd">    * SVFImageNet: image-based stationary velocity field</span>
<span class="sd">    * SVFMapNet: map-based stationary velocity field</span>
<span class="sd">    * SVFQuasiMomentumImageNet: EXPERIMENTAL (not working yet): SVF which is parameterized by a momentum</span>
<span class="sd">    * LDDMMShootingVectorMomentumImageNet: image-based LDDMM using the vector-momentum parameterization</span>
<span class="sd">    * LDDMMShootingVectorMomentumImageNet: map-based LDDMM using the vector-momentum parameterization</span>
<span class="sd">    * LDDMMShootingScalarMomentumImageNet: image-based LDDMM using the scalar-momentum parameterization</span>
<span class="sd">    * LDDMMShootingScalarMomentumImageNet: map-based LDDMM using the scalar-momentum parameterization</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>

<span class="kn">import</span> <span class="nn">rungekutta_integrators</span> <span class="k">as</span> <span class="nn">RK</span>
<span class="kn">import</span> <span class="nn">forward_models</span> <span class="k">as</span> <span class="nn">FM</span>
<span class="kn">from</span> <span class="nn">global_list</span> <span class="k">import</span> <span class="n">AdpatVal</span>
<span class="kn">import</span> <span class="nn">regularizer_factory</span> <span class="k">as</span> <span class="nn">RF</span>
<span class="kn">import</span> <span class="nn">similarity_measure_factory</span> <span class="k">as</span> <span class="nn">SM</span>

<span class="kn">import</span> <span class="nn">smoother_factory</span> <span class="k">as</span> <span class="nn">SF</span>
<span class="kn">import</span> <span class="nn">image_sampling</span> <span class="k">as</span> <span class="nn">IS</span>

<span class="kn">import</span> <span class="nn">utils</span>

<span class="kn">from</span> <span class="nn">abc</span> <span class="k">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>

<div class="viewcode-block" id="RegistrationNet"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationNet">[docs]</a><span class="k">class</span> <span class="nc">RegistrationNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base-class for all the registration networks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        </span>
<span class="sd">        :param sz: image size (BxCxXxYxZ format) </span>
<span class="sd">        :param spacing: spatial spacing, e.g., [0.1,0.1,0.2]</span>
<span class="sd">        :param params: ParameterDict() object to hold general parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RegistrationNet</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sz</span> <span class="o">=</span> <span class="n">sz</span>
        <span class="sd">&quot;&quot;&quot;image size&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="n">spacing</span>
        <span class="sd">&quot;&quot;&quot;image spacing&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="sd">&quot;&quot;&quot;ParameterDict() object for the parameters&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tFrom</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="sd">&quot;&quot;&quot;time to solve a model from&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tTo</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="sd">&quot;&quot;&quot;time to solve a model to&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrOfImages</span> <span class="o">=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="sd">&quot;&quot;&quot;the number of images, i.e., the batch size B&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrOfChannels</span> <span class="o">=</span> <span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="sd">&quot;&quot;&quot;the number of image channels, i.e., C&quot;&quot;&quot;</span>

<div class="viewcode-block" id="RegistrationNet.create_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationNet.create_registration_parameters">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">create_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method to create the registration parameters over which should be optimized. They need to be of type torch Parameter() </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RegistrationNet.get_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationNet.get_registration_parameters">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method to return the registration parameters</span>
<span class="sd">        </span>
<span class="sd">        :return: returns the registration parameters </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RegistrationNet.set_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationNet.set_registration_parameters">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">spacing</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method to set the registration parameters externally. This can for example be useful when the optimizer should be initialized at a specific value</span>
<span class="sd">        </span>
<span class="sd">        :param p: parameter to be set </span>
<span class="sd">        :param sz: size of the image the parameter corresponds to </span>
<span class="sd">        :param spacing: spacing of the image the parameter corresponds to </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RegistrationNet.create_integrator"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationNet.create_integrator">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">create_integrator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method to create an integrator for time-integration of a model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RegistrationNet.downsample_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationNet.downsample_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">downsample_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desiredSz</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to downsample the registration parameters spatially to a desired size. Should be overwritten by a derived class. </span>
<span class="sd">        </span>
<span class="sd">        :param desiredSz: desired size in XxZxZ format, e.g., [50,100,40]</span>
<span class="sd">        :return: should return a tuple (downsampled_image,downsampled_spacing) </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="RegistrationNet.upsample_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationNet.upsample_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">upsample_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desiredSz</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to upsample the registration parameters spatially to a desired size. Should be overwritten by a derived class. </span>

<span class="sd">        :param desiredSz: desired size in XxZxZ format, e.g., [50,100,40]</span>
<span class="sd">        :return: should return a tuple (upsampled_image,upsampled_spacing) </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="RegistrationNet.get_parameter_image_and_name_to_visualize"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationNet.get_parameter_image_and_name_to_visualize">[docs]</a>    <span class="k">def</span> <span class="nf">get_parameter_image_and_name_to_visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience function to specify an image that should be visualized including its caption. </span>
<span class="sd">        This will typically be related to the parameter of a model. This method should be overwritten by a derived class</span>
<span class="sd">         </span>
<span class="sd">        :return: should return a tuple (image,desired_caption)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># not defined yet</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span></div></div>

<div class="viewcode-block" id="SVFNet"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFNet">[docs]</a><span class="k">class</span> <span class="nc">SVFNet</span><span class="p">(</span><span class="n">RegistrationNet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for SVF-type registrations. Provides a velocity field (as a parameter) and an integrator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SVFNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_registration_parameters</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;velocity field that will be optimized over&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_integrator</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;integrator to do the time-integration&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SVFNet.create_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFNet.create_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">create_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the velocity field that is being optimized over</span>
<span class="sd">        </span>
<span class="sd">        :return: velocity field parameter </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">create_ND_vector_field_parameter_multiN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">::],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrOfImages</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVFNet.get_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFNet.get_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">get_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the velocity field parameter</span>
<span class="sd">        </span>
<span class="sd">        :return: velocity field parameter </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span></div>

<div class="viewcode-block" id="SVFNet.set_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFNet.set_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">set_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">spacing</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the velocity field registration parameter</span>
<span class="sd">        </span>
<span class="sd">        :param p: velocity field </span>
<span class="sd">        :param sz: size of the corresponding image</span>
<span class="sd">        :param spacing: spacing of the corresponding image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sz</span> <span class="o">=</span> <span class="n">sz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="n">spacing</span></div>

<div class="viewcode-block" id="SVFNet.get_parameter_image_and_name_to_visualize"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFNet.get_parameter_image_and_name_to_visualize">[docs]</a>    <span class="k">def</span> <span class="nf">get_parameter_image_and_name_to_visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the velocity field parameter magnitude image and a name</span>
<span class="sd">        </span>
<span class="sd">        :return: Returns the tuple (velocity_magnitude_image,name) </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;|v|&#39;</span>
        <span class="n">par_image</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span> <span class="c1"># assume BxCxXxYxZ format</span>
        <span class="k">return</span> <span class="n">par_image</span><span class="p">,</span><span class="n">name</span></div>

<div class="viewcode-block" id="SVFNet.upsample_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFNet.upsample_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">upsample_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desiredSz</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upsamples the velocity field to a desired size</span>
<span class="sd">        </span>
<span class="sd">        :param desiredSz: desired size of the upsampled velocity field </span>
<span class="sd">        :return: returns a tuple (upsampled_image,upsampled_spacing)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">IS</span><span class="o">.</span><span class="n">ResampleImage</span><span class="p">()</span>
        <span class="n">vUpsampled</span><span class="p">,</span><span class="n">upsampled_spacing</span><span class="o">=</span><span class="n">sampler</span><span class="o">.</span><span class="n">upsample_image_to_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span><span class="n">desiredSz</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vUpsampled</span><span class="p">,</span><span class="n">upsampled_spacing</span></div>

<div class="viewcode-block" id="SVFNet.downsample_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFNet.downsample_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">downsample_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desiredSz</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Downsamples the velocity field to a desired size</span>

<span class="sd">        :param desiredSz: desired size of the downsampled velocity field </span>
<span class="sd">        :return: returns a tuple (downsampled_image,downsampled_spacing)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">IS</span><span class="o">.</span><span class="n">ResampleImage</span><span class="p">()</span>
        <span class="n">vDownsampled</span><span class="p">,</span><span class="n">downsampled_spacing</span><span class="o">=</span><span class="n">sampler</span><span class="o">.</span><span class="n">downsample_image_to_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span><span class="n">desiredSz</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vDownsampled</span><span class="p">,</span><span class="n">downsampled_spacing</span></div></div>

<div class="viewcode-block" id="SVFImageNet"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFImageNet">[docs]</a><span class="k">class</span> <span class="nc">SVFImageNet</span><span class="p">(</span><span class="n">SVFNet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialization for SVF-based image registration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SVFImageNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="SVFImageNet.create_integrator"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFImageNet.create_integrator">[docs]</a>    <span class="k">def</span> <span class="nf">create_integrator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an integrator for the advection equation of the image</span>
<span class="sd">        </span>
<span class="sd">        :return: returns this integrator </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cparams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="s1">&#39;forward_model&#39;</span><span class="p">,{},</span><span class="s1">&#39;settings for the forward model&#39;</span><span class="p">)]</span>
        <span class="n">advection</span> <span class="o">=</span> <span class="n">FM</span><span class="o">.</span><span class="n">AdvectImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RK</span><span class="o">.</span><span class="n">RK4</span><span class="p">(</span><span class="n">advection</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="n">advection</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">cparams</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVFImageNet.forward"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFImageNet.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solves the image-based advection equation</span>
<span class="sd">        </span>
<span class="sd">        :param I: initial condition for the image </span>
<span class="sd">        :return: returns the image at the final time (tTo)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">I1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">solve</span><span class="p">([</span><span class="n">I</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tFrom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tTo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">I1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="SVFQuasiMomentumNet"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFQuasiMomentumNet">[docs]</a><span class="k">class</span> <span class="nc">SVFQuasiMomentumNet</span><span class="p">(</span><span class="n">RegistrationNet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempt at parameterizing SVF with a momentum-like vector field (EXPERIMENTAL, not working yet)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SVFQuasiMomentumNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_registration_parameters</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;momentum parameter&quot;&quot;&quot;</span>
        <span class="n">cparams</span> <span class="o">=</span> <span class="n">params</span><span class="p">[(</span><span class="s1">&#39;forward_model&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="s1">&#39;settings for the forward model&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smoother</span> <span class="o">=</span> <span class="n">SF</span><span class="o">.</span><span class="n">SmootherFactory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">::],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span><span class="o">.</span><span class="n">create_smoother</span><span class="p">(</span><span class="n">cparams</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;smoother to go from momentum to velocity&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoother</span><span class="o">.</span><span class="n">smooth_vector_field_multiN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;corresponding velocity field&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_integrator</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;integrator to solve the forward model&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SVFQuasiMomentumNet.create_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFQuasiMomentumNet.create_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">create_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the registration parameters (the momentum field) and returns them</span>
<span class="sd">        </span>
<span class="sd">        :return: momentum field </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">create_ND_vector_field_parameter_multiN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">::],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrOfImages</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVFQuasiMomentumNet.get_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFQuasiMomentumNet.get_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">get_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the registration parameters (the momentum field)</span>
<span class="sd">        </span>
<span class="sd">        :return: momentum field </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span></div>

<div class="viewcode-block" id="SVFQuasiMomentumNet.set_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFQuasiMomentumNet.set_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">set_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">spacing</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the registration parameters (the momentum field)</span>
<span class="sd">        </span>
<span class="sd">        :param p: momentum field </span>
<span class="sd">        :param sz: corresponding image size</span>
<span class="sd">        :param spacing: corresponding image spacing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sz</span> <span class="o">=</span> <span class="n">sz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="n">spacing</span></div>

<div class="viewcode-block" id="SVFQuasiMomentumNet.get_parameter_image_and_name_to_visualize"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFQuasiMomentumNet.get_parameter_image_and_name_to_visualize">[docs]</a>    <span class="k">def</span> <span class="nf">get_parameter_image_and_name_to_visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the momentum magnitude image and :math:`|m|` as the image caption</span>
<span class="sd">        </span>
<span class="sd">        :return: Returns a tuple (magnitude_m,name) </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;|m|&#39;</span>
        <span class="n">par_image</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span> <span class="c1"># assume BxCxXxYxZ format</span>
        <span class="k">return</span> <span class="n">par_image</span><span class="p">,</span><span class="n">name</span></div>

<div class="viewcode-block" id="SVFQuasiMomentumNet.upsample_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFQuasiMomentumNet.upsample_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">upsample_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desiredSz</span><span class="p">):</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">IS</span><span class="o">.</span><span class="n">ResampleImage</span><span class="p">()</span>
        <span class="n">mUpsampled</span><span class="p">,</span><span class="n">upsampled_spacing</span><span class="o">=</span><span class="n">sampler</span><span class="o">.</span><span class="n">upsample_image_to_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span><span class="n">desiredSz</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mUpsampled</span><span class="p">,</span><span class="n">upsampled_spacing</span></div>

<div class="viewcode-block" id="SVFQuasiMomentumNet.downsample_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFQuasiMomentumNet.downsample_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">downsample_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desiredSz</span><span class="p">):</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">IS</span><span class="o">.</span><span class="n">ResampleImage</span><span class="p">()</span>
        <span class="n">mDownsampled</span><span class="p">,</span><span class="n">downsampled_spacing</span><span class="o">=</span><span class="n">sampler</span><span class="o">.</span><span class="n">downsample_image_to_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span><span class="n">desiredSz</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mDownsampled</span><span class="p">,</span><span class="n">downsampled_spacing</span></div></div>

<div class="viewcode-block" id="SVFQuasiMomentumImageNet"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFQuasiMomentumImageNet">[docs]</a><span class="k">class</span> <span class="nc">SVFQuasiMomentumImageNet</span><span class="p">(</span><span class="n">SVFQuasiMomentumNet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialization for image registation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SVFQuasiMomentumImageNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="SVFQuasiMomentumImageNet.create_integrator"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFQuasiMomentumImageNet.create_integrator">[docs]</a>    <span class="k">def</span> <span class="nf">create_integrator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the integrator that solve the advection equation (based on the smoothed momentum)</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cparams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="s1">&#39;forward_model&#39;</span><span class="p">,{},</span><span class="s1">&#39;settings for the forward model&#39;</span><span class="p">)]</span>
        <span class="n">advection</span> <span class="o">=</span> <span class="n">FM</span><span class="o">.</span><span class="n">AdvectImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RK</span><span class="o">.</span><span class="n">RK4</span><span class="p">(</span><span class="n">advection</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="n">advection</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">cparams</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVFQuasiMomentumImageNet.forward"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFQuasiMomentumImageNet.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solves the model by first smoothing the momentum field and then using it as the velocity for the advection equation</span>
<span class="sd">        </span>
<span class="sd">        :param I: initial condition for the image </span>
<span class="sd">        :return: returns the image at the final time point (tTo)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smoother</span><span class="o">.</span><span class="n">smooth_vector_field_multiN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
        <span class="n">I1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">solve</span><span class="p">([</span><span class="n">I</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tFrom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tTo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">I1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div></div>

<div class="viewcode-block" id="RegistrationLoss"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationLoss">[docs]</a><span class="k">class</span> <span class="nc">RegistrationLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class to define a loss function for image registration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        </span>
<span class="sd">        :param sz: image size </span>
<span class="sd">        :param spacing: image spacing</span>
<span class="sd">        :param params: ParameterDict() object to hold and keep track of general parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RegistrationLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="n">spacing</span>
        <span class="sd">&quot;&quot;&quot;image spacing&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sz</span> <span class="o">=</span> <span class="n">sz</span>
        <span class="sd">&quot;&quot;&quot;image size&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="sd">&quot;&quot;&quot;ParameterDict() paramters&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">smFactory</span> <span class="o">=</span> <span class="n">SM</span><span class="o">.</span><span class="n">SimilarityMeasureFactory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;factory to create similarity measures on the fly&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarityMeasure</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;the similarity measure itself&quot;&quot;&quot;</span>

<div class="viewcode-block" id="RegistrationLoss.add_similarity_measure"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationLoss.add_similarity_measure">[docs]</a>    <span class="k">def</span> <span class="nf">add_similarity_measure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simName</span><span class="p">,</span> <span class="n">simMeasure</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To add a custom similarity measure to the similarity measure factory</span>
<span class="sd">        </span>
<span class="sd">        :param simName: desired name of the similarity measure (string) </span>
<span class="sd">        :param simMeasure: similarity measure itself (to instantiate an object)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smFactory</span><span class="o">.</span><span class="n">add_similarity_measure</span><span class="p">(</span><span class="n">simName</span><span class="p">,</span><span class="n">simMeasure</span><span class="p">)</span></div>

<div class="viewcode-block" id="RegistrationLoss.compute_similarity_energy"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationLoss.compute_similarity_energy">[docs]</a>    <span class="k">def</span> <span class="nf">compute_similarity_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I1_warped</span><span class="p">,</span> <span class="n">I1_target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computing the image matching energy based on the selected similarity measure</span>
<span class="sd">        </span>
<span class="sd">        :param I1_warped: warped image at time tTo </span>
<span class="sd">        :param I1_target: target image to register to </span>
<span class="sd">        :return: returns the value for image similarity energy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarityMeasure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">similarityMeasure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smFactory</span><span class="o">.</span><span class="n">create_similarity_measure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarityMeasure</span><span class="o">.</span><span class="n">compute_similarity_multiNC</span><span class="p">(</span><span class="n">I1_warped</span><span class="p">,</span> <span class="n">I1_target</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sim</span></div>

<div class="viewcode-block" id="RegistrationLoss.compute_regularization_energy"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationLoss.compute_regularization_energy">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">compute_regularization_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method computing the regularization energy based on the registration parameters and (if desired) the initial image</span>
<span class="sd">        </span>
<span class="sd">        :param I0_source: Initial image </span>
<span class="sd">        :return: should return the valie for the regularization energy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="RegistrationImageLoss"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationImageLoss">[docs]</a><span class="k">class</span> <span class="nc">RegistrationImageLoss</span><span class="p">(</span><span class="n">RegistrationLoss</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialization for image-based registration losses</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RegistrationImageLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="RegistrationImageLoss.get_energy"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationImageLoss.get_energy">[docs]</a>    <span class="k">def</span> <span class="nf">get_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I1_warped</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">,</span> <span class="n">I1_target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the overall registration energy as E = E_sim + E_reg</span>
<span class="sd">        </span>
<span class="sd">        :param I1_warped: warped image </span>
<span class="sd">        :param I0_source: source image</span>
<span class="sd">        :param I1_target: target image</span>
<span class="sd">        :return: return the energy value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_similarity_energy</span><span class="p">(</span><span class="n">I1_warped</span><span class="p">,</span> <span class="n">I1_target</span><span class="p">)</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_regularization_energy</span><span class="p">(</span><span class="n">I0_source</span><span class="p">)</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">sim</span> <span class="o">+</span> <span class="n">reg</span>
        <span class="k">return</span> <span class="n">energy</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">reg</span></div>

<div class="viewcode-block" id="RegistrationImageLoss.forward"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationImageLoss.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I1_warped</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">,</span> <span class="n">I1_target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the loss by evaluating the energy</span>
<span class="sd">        :param I1_warped: warped image</span>
<span class="sd">        :param I0_source: source image</span>
<span class="sd">        :param I1_target: target image</span>
<span class="sd">        :return: registration energy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">energy</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_energy</span><span class="p">(</span><span class="n">I1_warped</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">,</span> <span class="n">I1_target</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">energy</span></div></div>


<div class="viewcode-block" id="RegistrationMapLoss"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationMapLoss">[docs]</a><span class="k">class</span> <span class="nc">RegistrationMapLoss</span><span class="p">(</span><span class="n">RegistrationLoss</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialization for map-based registration losses</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RegistrationMapLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="RegistrationMapLoss.get_energy"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationMapLoss.get_energy">[docs]</a>    <span class="k">def</span> <span class="nf">get_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phi1</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">,</span> <span class="n">I1_target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the energy by warping the source image via the map and then comparing it to the target image</span>
<span class="sd">        </span>
<span class="sd">        :param phi1: map (mapping the source image to the target image, defined in the space of the target image) </span>
<span class="sd">        :param I0_source: source image</span>
<span class="sd">        :param I1_target: target image</span>
<span class="sd">        :return: registration energy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">I1_warped</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">compute_warped_image_multiNC</span><span class="p">(</span><span class="n">I0_source</span><span class="p">,</span> <span class="n">phi1</span><span class="p">)</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_similarity_energy</span><span class="p">(</span><span class="n">I1_warped</span><span class="p">,</span> <span class="n">I1_target</span><span class="p">)</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_regularization_energy</span><span class="p">(</span><span class="n">I0_source</span><span class="p">)</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">sim</span> <span class="o">+</span> <span class="n">reg</span>
        <span class="k">return</span> <span class="n">energy</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">reg</span></div>

<div class="viewcode-block" id="RegistrationMapLoss.forward"><a class="viewcode-back" href="../registration_networks.html#registration_networks.RegistrationMapLoss.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phi1</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">,</span> <span class="n">I1_target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the loss function value by evaluating the registration energy</span>
<span class="sd">        </span>
<span class="sd">        :param phi1:  map (mapping the source image to the target image, defined in the space of the target image) </span>
<span class="sd">        :param I0_source: source image</span>
<span class="sd">        :param I1_target: target image</span>
<span class="sd">        :return: returns the value of the loss function (i.e., the registration energy)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">energy</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_energy</span><span class="p">(</span><span class="n">phi1</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">,</span> <span class="n">I1_target</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">energy</span></div></div>


<div class="viewcode-block" id="SVFImageLoss"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFImageLoss">[docs]</a><span class="k">class</span> <span class="nc">SVFImageLoss</span><span class="p">(</span><span class="n">RegistrationImageLoss</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loss specialization for image-based SVF </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        </span>
<span class="sd">        :param v: velocity field parameter </span>
<span class="sd">        :param sz: size of image</span>
<span class="sd">        :param spacing: spacing of image</span>
<span class="sd">        :param params: general parameters via ParameterDict()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SVFImageLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>
        <span class="sd">&quot;&quot;&quot;veclocity field parameter&quot;&quot;&quot;</span>

        <span class="n">cparams</span> <span class="o">=</span> <span class="n">params</span><span class="p">[(</span><span class="s1">&#39;loss&#39;</span><span class="p">,{},</span><span class="s1">&#39;settings for the loss function&#39;</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">regularizer</span> <span class="o">=</span> <span class="p">(</span><span class="n">RF</span><span class="o">.</span><span class="n">RegularizerFactory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span><span class="o">.</span>
                            <span class="n">create_regularizer</span><span class="p">(</span><span class="n">cparams</span><span class="p">))</span>
        <span class="sd">&quot;&quot;&quot;regularizer to compute the regularization energy&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SVFImageLoss.compute_regularization_energy"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFImageLoss.compute_regularization_energy">[docs]</a>    <span class="k">def</span> <span class="nf">compute_regularization_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computing the regularization energy</span>
<span class="sd">        </span>
<span class="sd">        :param I0_source: source image (not used)</span>
<span class="sd">        :return: returns the regularization energy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularizer</span><span class="o">.</span><span class="n">compute_regularizer_multiN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SVFQuasiMomentumImageLoss"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFQuasiMomentumImageLoss">[docs]</a><span class="k">class</span> <span class="nc">SVFQuasiMomentumImageLoss</span><span class="p">(</span><span class="n">RegistrationImageLoss</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loss function specialization for the image-based quasi-momentum SVF implementation.</span>
<span class="sd">    Essentially the same as for SVF but has to smooth the momentum field first to obtain the velocity field.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        </span>
<span class="sd">        :param m: momentum field </span>
<span class="sd">        :param sz: image size</span>
<span class="sd">        :param spacing: image spacing</span>
<span class="sd">        :param params: ParameterDict() parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SVFQuasiMomentumImageLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
        <span class="sd">&quot;&quot;&quot;vector momentum&quot;&quot;&quot;</span>

        <span class="n">cparams</span> <span class="o">=</span> <span class="n">params</span><span class="p">[(</span><span class="s1">&#39;loss&#39;</span><span class="p">,{},</span><span class="s1">&#39;settings for the loss function&#39;</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">regularizer</span> <span class="o">=</span> <span class="p">(</span><span class="n">RF</span><span class="o">.</span><span class="n">RegularizerFactory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span><span class="o">.</span>
                            <span class="n">create_regularizer</span><span class="p">(</span><span class="n">cparams</span><span class="p">))</span>
        <span class="sd">&quot;&quot;&quot;regularizer to compute the regularization energy&quot;&quot;&quot;</span>

        <span class="n">cparams</span> <span class="o">=</span> <span class="n">params</span><span class="p">[(</span><span class="s1">&#39;forward_model&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="s1">&#39;settings for the forward model&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smoother</span> <span class="o">=</span> <span class="n">SF</span><span class="o">.</span><span class="n">SmootherFactory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">::],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span><span class="o">.</span><span class="n">create_smoother</span><span class="p">(</span><span class="n">cparams</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;smoother to convert from momentum to velocity&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SVFQuasiMomentumImageLoss.compute_regularization_energy"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFQuasiMomentumImageLoss.compute_regularization_energy">[docs]</a>    <span class="k">def</span> <span class="nf">compute_regularization_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the regularization energy from the momentum</span>
<span class="sd">        </span>
<span class="sd">        :param I0_source: not used</span>
<span class="sd">        :return: returns the regularization energy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoother</span><span class="o">.</span><span class="n">smooth_vector_field_multiN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularizer</span><span class="o">.</span><span class="n">compute_regularizer_multiN</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="SVFMapNet"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFMapNet">[docs]</a><span class="k">class</span> <span class="nc">SVFMapNet</span><span class="p">(</span><span class="n">SVFNet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Network specialization to a map-based SVF </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SVFMapNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="SVFMapNet.create_integrator"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFMapNet.create_integrator">[docs]</a>    <span class="k">def</span> <span class="nf">create_integrator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an integrator to solve a map-based advection equation</span>
<span class="sd">        </span>
<span class="sd">        :return: returns this integrator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cparams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="s1">&#39;forward_model&#39;</span><span class="p">,{},</span><span class="s1">&#39;settings for the forward model&#39;</span><span class="p">)]</span>
        <span class="n">advectionMap</span> <span class="o">=</span> <span class="n">FM</span><span class="o">.</span><span class="n">AdvectMap</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">RK</span><span class="o">.</span><span class="n">RK4</span><span class="p">(</span><span class="n">advectionMap</span><span class="o">.</span><span class="n">f</span><span class="p">,</span><span class="n">advectionMap</span><span class="o">.</span><span class="n">u</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">cparams</span><span class="p">)</span></div>

<div class="viewcode-block" id="SVFMapNet.forward"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFMapNet.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solved the map-based equation forward</span>
<span class="sd">        </span>
<span class="sd">        :param phi: initial condition for the map</span>
<span class="sd">        :param I0_source: not used</span>
<span class="sd">        :return: returns the map at time tTo</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phi1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">solve</span><span class="p">([</span><span class="n">phi</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tFrom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tTo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phi1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="SVFMapLoss"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFMapLoss">[docs]</a><span class="k">class</span> <span class="nc">SVFMapLoss</span><span class="p">(</span><span class="n">RegistrationMapLoss</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialization of the loss function for SVF to a map-based solution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SVFMapLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>
        <span class="sd">&quot;&quot;&quot;velocity field parameter&quot;&quot;&quot;</span>

        <span class="n">cparams</span> <span class="o">=</span> <span class="n">params</span><span class="p">[(</span><span class="s1">&#39;loss&#39;</span><span class="p">,{},</span><span class="s1">&#39;settings for the loss function&#39;</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">regularizer</span> <span class="o">=</span> <span class="p">(</span><span class="n">RF</span><span class="o">.</span><span class="n">RegularizerFactory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span><span class="o">.</span>
                            <span class="n">create_regularizer</span><span class="p">(</span><span class="n">cparams</span><span class="p">))</span>
        <span class="sd">&quot;&quot;&quot;regularizer to compute the regularization energy&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SVFMapLoss.compute_regularization_energy"><a class="viewcode-back" href="../registration_networks.html#registration_networks.SVFMapLoss.compute_regularization_energy">[docs]</a>    <span class="k">def</span> <span class="nf">compute_regularization_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the regularizaton energy from the velocity field parameter</span>
<span class="sd">        </span>
<span class="sd">        :param I0_source: not used </span>
<span class="sd">        :return: returns the regularization energy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularizer</span><span class="o">.</span><span class="n">compute_regularizer_multiN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LDDMMShootingVectorMomentumNet"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumNet">[docs]</a><span class="k">class</span> <span class="nc">LDDMMShootingVectorMomentumNet</span><span class="p">(</span><span class="n">RegistrationNet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialization to vector-momentum-based shooting for LDDMM</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LDDMMShootingVectorMomentumNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_registration_parameters</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;vector momentum&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_integrator</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;integrator to solve EPDiff variant&quot;&quot;&quot;</span>

<div class="viewcode-block" id="LDDMMShootingVectorMomentumNet.create_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumNet.create_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">create_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the vector momentum parameter</span>
<span class="sd">        </span>
<span class="sd">        :return: Returns the vector momentum parameter </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">create_ND_vector_field_parameter_multiN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">::],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrOfImages</span><span class="p">)</span></div>

<div class="viewcode-block" id="LDDMMShootingVectorMomentumNet.get_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumNet.get_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">get_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the vector momentum parameter</span>
<span class="sd">        </span>
<span class="sd">        :return: vector momentum </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span></div>

<div class="viewcode-block" id="LDDMMShootingVectorMomentumNet.set_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumNet.set_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">set_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">spacing</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the vector momentum registration parameter</span>
<span class="sd">        </span>
<span class="sd">        :param p: vector momentum </span>
<span class="sd">        :param sz: size of image</span>
<span class="sd">        :param spacing: spacing of image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sz</span> <span class="o">=</span> <span class="n">sz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="n">spacing</span></div>

<div class="viewcode-block" id="LDDMMShootingVectorMomentumNet.get_parameter_image_and_name_to_visualize"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumNet.get_parameter_image_and_name_to_visualize">[docs]</a>    <span class="k">def</span> <span class="nf">get_parameter_image_and_name_to_visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a magnitude image for the momentum and returns it with name :math:`|m|`</span>
<span class="sd">        </span>
<span class="sd">        :return: Returns tuple (m_magnitude_image,name) </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;|m|&#39;</span>
        <span class="n">par_image</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span> <span class="c1"># assume BxCxXxYxZ format</span>
        <span class="k">return</span> <span class="n">par_image</span><span class="p">,</span><span class="n">name</span></div>

<div class="viewcode-block" id="LDDMMShootingVectorMomentumNet.upsample_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumNet.upsample_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">upsample_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desiredSz</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upsamples the vector-momentum parameter</span>
<span class="sd">        </span>
<span class="sd">        :param desiredSz: desired size of the upsampled momentum </span>
<span class="sd">        :return: Returns tuple (upsampled_momentum,upsampled_spacing)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sampler</span> <span class="o">=</span> <span class="n">IS</span><span class="o">.</span><span class="n">ResampleImage</span><span class="p">()</span>
        <span class="n">mUpsampled</span><span class="p">,</span> <span class="n">upsampled_spacing</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">upsample_image_to_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span> <span class="n">desiredSz</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mUpsampled</span><span class="p">,</span><span class="n">upsampled_spacing</span></div>

<div class="viewcode-block" id="LDDMMShootingVectorMomentumNet.downsample_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumNet.downsample_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">downsample_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desiredSz</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Downsamples the vector-momentum parameter</span>

<span class="sd">        :param desiredSz: desired size of the downsampled momentum </span>
<span class="sd">        :return: Returns tuple (downsampled_momentum,downsampled_spacing)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sampler</span> <span class="o">=</span> <span class="n">IS</span><span class="o">.</span><span class="n">ResampleImage</span><span class="p">()</span>
        <span class="n">mDownsampled</span><span class="p">,</span><span class="n">downsampled_spacing</span><span class="o">=</span><span class="n">sampler</span><span class="o">.</span><span class="n">downsample_image_to_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span><span class="n">desiredSz</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mDownsampled</span><span class="p">,</span> <span class="n">downsampled_spacing</span></div></div>

<div class="viewcode-block" id="LDDMMShootingVectorMomentumImageNet"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumImageNet">[docs]</a><span class="k">class</span> <span class="nc">LDDMMShootingVectorMomentumImageNet</span><span class="p">(</span><span class="n">LDDMMShootingVectorMomentumNet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialization of vector-momentum LDDMM for direct image matching.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LDDMMShootingVectorMomentumImageNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="LDDMMShootingVectorMomentumImageNet.create_integrator"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumImageNet.create_integrator">[docs]</a>    <span class="k">def</span> <span class="nf">create_integrator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates integrator to solve EPDiff together with an advevtion equation for the image</span>
<span class="sd">        </span>
<span class="sd">        :return: returns this integrator </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cparams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="s1">&#39;forward_model&#39;</span><span class="p">,{},</span><span class="s1">&#39;settings for the forward model&#39;</span><span class="p">)]</span>
        <span class="n">epdiffImage</span> <span class="o">=</span> <span class="n">FM</span><span class="o">.</span><span class="n">EPDiffImage</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span> <span class="n">cparams</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">RK</span><span class="o">.</span><span class="n">RK4</span><span class="p">(</span><span class="n">epdiffImage</span><span class="o">.</span><span class="n">f</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">cparams</span><span class="p">)</span></div>

<div class="viewcode-block" id="LDDMMShootingVectorMomentumImageNet.forward"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumImageNet.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integrates EPDiff plus advection equation for image forward</span>
<span class="sd">        </span>
<span class="sd">        :param I: Initial condition for image </span>
<span class="sd">        :return: returns the image at time tTo</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mI1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">solve</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span><span class="n">I</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tFrom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tTo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mI1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="LDDMMShootingVectorMomentumImageLoss"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumImageLoss">[docs]</a><span class="k">class</span> <span class="nc">LDDMMShootingVectorMomentumImageLoss</span><span class="p">(</span><span class="n">RegistrationImageLoss</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialization of the image loss to vector-momentum LDDMM</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LDDMMShootingVectorMomentumImageLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
        <span class="sd">&quot;&quot;&quot;momentum&quot;&quot;&quot;</span>

        <span class="n">cparams</span> <span class="o">=</span> <span class="n">params</span><span class="p">[(</span><span class="s1">&#39;forward_model&#39;</span><span class="p">,{},</span><span class="s1">&#39;settings for the forward model&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smoother</span> <span class="o">=</span> <span class="n">SF</span><span class="o">.</span><span class="n">SmootherFactory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">::],</span><span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span><span class="o">.</span><span class="n">create_smoother</span><span class="p">(</span><span class="n">cparams</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;smoother to convert from momentum to velocity&quot;&quot;&quot;</span>

<div class="viewcode-block" id="LDDMMShootingVectorMomentumImageLoss.compute_regularization_energy"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumImageLoss.compute_regularization_energy">[docs]</a>    <span class="k">def</span> <span class="nf">compute_regularization_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the regularzation energy based on the inital momentum</span>
<span class="sd">        :param I0_source: not used</span>
<span class="sd">        :return: regularization energy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoother</span><span class="o">.</span><span class="n">smooth_vector_field_multiN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">reg</span></div></div>


<div class="viewcode-block" id="LDDMMShootingVectorMomentumMapNet"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumMapNet">[docs]</a><span class="k">class</span> <span class="nc">LDDMMShootingVectorMomentumMapNet</span><span class="p">(</span><span class="n">LDDMMShootingVectorMomentumNet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialization for map-based vector-momentum where the map itself is advected</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LDDMMShootingVectorMomentumMapNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="LDDMMShootingVectorMomentumMapNet.create_integrator"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumMapNet.create_integrator">[docs]</a>    <span class="k">def</span> <span class="nf">create_integrator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an integrator for EPDiff + advection equation for the map</span>
<span class="sd">        </span>
<span class="sd">        :return: returns this integrator </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cparams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="s1">&#39;forward_model&#39;</span><span class="p">,{},</span><span class="s1">&#39;settings for the forward model&#39;</span><span class="p">)]</span>
        <span class="n">epdiffMap</span> <span class="o">=</span> <span class="n">FM</span><span class="o">.</span><span class="n">EPDiffMap</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span> <span class="n">cparams</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">RK</span><span class="o">.</span><span class="n">RK4</span><span class="p">(</span><span class="n">epdiffMap</span><span class="o">.</span><span class="n">f</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">cparams</span><span class="p">)</span></div>

<div class="viewcode-block" id="LDDMMShootingVectorMomentumMapNet.forward"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumMapNet.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solves EPDiff + advection equation forward and returns the map at time tTo</span>
<span class="sd">        </span>
<span class="sd">        :param phi: initial condition for the map </span>
<span class="sd">        :param I0_source: not used</span>
<span class="sd">        :return: returns the map at time tTo</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mphi1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">solve</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span><span class="n">phi</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tFrom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tTo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mphi1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="LDDMMShootingVectorMomentumMapLoss"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumMapLoss">[docs]</a><span class="k">class</span> <span class="nc">LDDMMShootingVectorMomentumMapLoss</span><span class="p">(</span><span class="n">RegistrationMapLoss</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialization of the loss for map-based vector momumentum. Image similarity is computed based on warping the source</span>
<span class="sd">    image with the advected map.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LDDMMShootingVectorMomentumMapLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
        <span class="sd">&quot;&quot;&quot;vector momentum&quot;&quot;&quot;</span>

        <span class="n">cparams</span> <span class="o">=</span> <span class="n">params</span><span class="p">[(</span><span class="s1">&#39;forward_model&#39;</span><span class="p">,{},</span><span class="s1">&#39;settings for the forward model&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smoother</span> <span class="o">=</span> <span class="n">SF</span><span class="o">.</span><span class="n">SmootherFactory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">::],</span><span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span><span class="o">.</span><span class="n">create_smoother</span><span class="p">(</span><span class="n">cparams</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;smoother to obtain the velocity field from the momentum field&quot;&quot;&quot;</span>

<div class="viewcode-block" id="LDDMMShootingVectorMomentumMapLoss.compute_regularization_energy"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingVectorMomentumMapLoss.compute_regularization_energy">[docs]</a>    <span class="k">def</span> <span class="nf">compute_regularization_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Commputes the regularization energy from the initial vector momentum</span>
<span class="sd">        </span>
<span class="sd">        :param I0_source: not used </span>
<span class="sd">        :return: returns the regularization energy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoother</span><span class="o">.</span><span class="n">smooth_vector_field_multiN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">AdpatVal</span><span class="p">((</span><span class="n">v</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="o">.</span><span class="n">prod</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">reg</span></div></div>


<div class="viewcode-block" id="LDDMMShootingScalarMomentumNet"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumNet">[docs]</a><span class="k">class</span> <span class="nc">LDDMMShootingScalarMomentumNet</span><span class="p">(</span><span class="n">RegistrationNet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialization of the registration network to registrations with scalar momentum. Provides an integrator</span>
<span class="sd">    and the scalar momentum parameter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LDDMMShootingScalarMomentumNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_registration_parameters</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;scalar momentum&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_integrator</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;integrator to integrate EPDiff and associated equations (for image or map)&quot;&quot;&quot;</span>

<div class="viewcode-block" id="LDDMMShootingScalarMomentumNet.create_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumNet.create_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">create_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the scalar momentum registration parameter</span>
<span class="sd">        </span>
<span class="sd">        :return: Returns this scalar momentum parameter </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">create_ND_scalar_field_parameter_multiNC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">::],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrOfImages</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrOfChannels</span><span class="p">)</span></div>

<div class="viewcode-block" id="LDDMMShootingScalarMomentumNet.get_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumNet.get_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">get_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the scalar momentum registration parameter</span>
<span class="sd">        </span>
<span class="sd">        :return: scalar momentum </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lam</span></div>

<div class="viewcode-block" id="LDDMMShootingScalarMomentumNet.set_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumNet.set_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">set_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">spacing</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the scalar momentum registration parameter</span>
<span class="sd">        </span>
<span class="sd">        :param p: scalar momentum </span>
<span class="sd">        :param sz: image size</span>
<span class="sd">        :param spacing: image spacing </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sz</span> <span class="o">=</span> <span class="n">sz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="n">spacing</span></div>

<div class="viewcode-block" id="LDDMMShootingScalarMomentumNet.get_parameter_image_and_name_to_visualize"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumNet.get_parameter_image_and_name_to_visualize">[docs]</a>    <span class="k">def</span> <span class="nf">get_parameter_image_and_name_to_visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an image of the scalar momentum (magnitude over all channels) and &#39;lambda&#39; as name</span>
<span class="sd">        </span>
<span class="sd">        :return: Returns tuple (lamda_magnitude,lambda_name) </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lambda&#39;</span>
        <span class="n">par_image</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span> <span class="c1"># assume BxCxXxYxZ format</span>
        <span class="k">return</span> <span class="n">par_image</span><span class="p">,</span><span class="n">name</span></div>

<div class="viewcode-block" id="LDDMMShootingScalarMomentumNet.upsample_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumNet.upsample_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">upsample_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desiredSz</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upsample the scalar momentum</span>
<span class="sd">        </span>
<span class="sd">        :param desiredSz: desired size to be upsampled to, e.g., [100,50,40] </span>
<span class="sd">        :return: returns a tuple (upsampled_scalar_momentum,upsampled_spacing)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sampler</span> <span class="o">=</span> <span class="n">IS</span><span class="o">.</span><span class="n">ResampleImage</span><span class="p">()</span>
        <span class="n">lamUpsampled</span><span class="p">,</span> <span class="n">upsampled_spacing</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">upsample_image_to_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span> <span class="n">desiredSz</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lamUpsampled</span><span class="p">,</span><span class="n">upsampled_spacing</span></div>

<div class="viewcode-block" id="LDDMMShootingScalarMomentumNet.downsample_registration_parameters"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumNet.downsample_registration_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">downsample_registration_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desiredSz</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Downsample the scalar momentum</span>

<span class="sd">        :param desiredSz: desired size to be downsampled to, e.g., [40,20,10] </span>
<span class="sd">        :return: returns a tuple (downsampled_scalar_momentum,downsampled_spacing)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sampler</span> <span class="o">=</span> <span class="n">IS</span><span class="o">.</span><span class="n">ResampleImage</span><span class="p">()</span>
        <span class="n">lamDownsampled</span><span class="p">,</span><span class="n">downsampled_spacing</span><span class="o">=</span><span class="n">sampler</span><span class="o">.</span><span class="n">downsample_image_to_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span><span class="n">desiredSz</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lamDownsampled</span><span class="p">,</span> <span class="n">downsampled_spacing</span></div></div>

<div class="viewcode-block" id="LDDMMShootingScalarMomentumImageNet"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumImageNet">[docs]</a><span class="k">class</span> <span class="nc">LDDMMShootingScalarMomentumImageNet</span><span class="p">(</span><span class="n">LDDMMShootingScalarMomentumNet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialization of scalar-momentum LDDMM to image-based matching</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LDDMMShootingScalarMomentumImageNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="LDDMMShootingScalarMomentumImageNet.create_integrator"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumImageNet.create_integrator">[docs]</a>    <span class="k">def</span> <span class="nf">create_integrator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an integrator integrating the scalar momentum conservation law and an advection equation for the image</span>
<span class="sd">        </span>
<span class="sd">        :return: returns this integrator </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cparams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="s1">&#39;forward_model&#39;</span><span class="p">,{},</span><span class="s1">&#39;settings for the forward model&#39;</span><span class="p">)]</span>
        <span class="n">epdiffScalarMomentumImage</span> <span class="o">=</span> <span class="n">FM</span><span class="o">.</span><span class="n">EPDiffScalarMomentumImage</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span> <span class="n">cparams</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">RK</span><span class="o">.</span><span class="n">RK4</span><span class="p">(</span><span class="n">epdiffScalarMomentumImage</span><span class="o">.</span><span class="n">f</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">cparams</span><span class="p">)</span></div>

<div class="viewcode-block" id="LDDMMShootingScalarMomentumImageNet.forward"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumImageNet.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solved the scalar momentum forward equation and returns the image at time tTo</span>
<span class="sd">        </span>
<span class="sd">        :param I: initial image </span>
<span class="sd">        :return: image at time tTo</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lamI1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">solve</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">,</span><span class="n">I</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tFrom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tTo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lamI1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="LDDMMShootingScalarMomentumImageLoss"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumImageLoss">[docs]</a><span class="k">class</span> <span class="nc">LDDMMShootingScalarMomentumImageLoss</span><span class="p">(</span><span class="n">RegistrationImageLoss</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialization of the loss to scalar-momentum LDDMM on images</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lam</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LDDMMShootingScalarMomentumImageLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="n">lam</span>
        <span class="sd">&quot;&quot;&quot;scalar momentum&quot;&quot;&quot;</span>

        <span class="n">cparams</span> <span class="o">=</span> <span class="n">params</span><span class="p">[(</span><span class="s1">&#39;forward_model&#39;</span><span class="p">,{},</span><span class="s1">&#39;settings for the forward model&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smoother</span> <span class="o">=</span> <span class="n">SF</span><span class="o">.</span><span class="n">SmootherFactory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">::],</span><span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span><span class="o">.</span><span class="n">create_smoother</span><span class="p">(</span><span class="n">cparams</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;smoother to go from momentum to velocity&quot;&quot;&quot;</span>

<div class="viewcode-block" id="LDDMMShootingScalarMomentumImageLoss.compute_regularization_energy"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumImageLoss.compute_regularization_energy">[docs]</a>    <span class="k">def</span> <span class="nf">compute_regularization_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the regularization energy from the initial vector momentum as obtained from the scalar momentum</span>
<span class="sd">        </span>
<span class="sd">        :param I0_source: source image </span>
<span class="sd">        :return: returns the regularization energy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">compute_vector_momentum_from_scalar_momentum_multiNC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoother</span><span class="o">.</span><span class="n">smooth_vector_field_multiN</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">reg</span></div></div>


<div class="viewcode-block" id="LDDMMShootingScalarMomentumMapNet"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumMapNet">[docs]</a><span class="k">class</span> <span class="nc">LDDMMShootingScalarMomentumMapNet</span><span class="p">(</span><span class="n">LDDMMShootingScalarMomentumNet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialization of scalar-momentum LDDMM registration to map-based image matching</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LDDMMShootingScalarMomentumMapNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>

<div class="viewcode-block" id="LDDMMShootingScalarMomentumMapNet.create_integrator"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumMapNet.create_integrator">[docs]</a>    <span class="k">def</span> <span class="nf">create_integrator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an integrator integrating the scalar conservation law for the scalar momentum,</span>
<span class="sd">        the advection equation for the image and the advection equation for the map,</span>
<span class="sd">        </span>
<span class="sd">        :return: returns this integrator </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cparams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[(</span><span class="s1">&#39;forward_model&#39;</span><span class="p">,{},</span><span class="s1">&#39;settings for the forward model&#39;</span><span class="p">)]</span>
        <span class="n">epdiffScalarMomentumMap</span> <span class="o">=</span> <span class="n">FM</span><span class="o">.</span><span class="n">EPDiffScalarMomentumMap</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span> <span class="n">cparams</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">RK</span><span class="o">.</span><span class="n">RK4</span><span class="p">(</span><span class="n">epdiffScalarMomentumMap</span><span class="o">.</span><span class="n">f</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">cparams</span><span class="p">)</span></div>

<div class="viewcode-block" id="LDDMMShootingScalarMomentumMapNet.forward"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumMapNet.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solves the scalar conservation law and the two advection equations forward in time.</span>
<span class="sd">        </span>
<span class="sd">        :param phi: initial condition for the map </span>
<span class="sd">        :param I0_source: initial condition for the image</span>
<span class="sd">        :return: returns the map at time tTo</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lamIphi1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">solve</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">,</span><span class="n">I0_source</span><span class="p">,</span> <span class="n">phi</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tFrom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tTo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lamIphi1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="LDDMMShootingScalarMomentumMapLoss"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumMapLoss">[docs]</a><span class="k">class</span> <span class="nc">LDDMMShootingScalarMomentumMapLoss</span><span class="p">(</span><span class="n">RegistrationMapLoss</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specialization of the loss function to scalar-momentum LDDMM for maps. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lam</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LDDMMShootingScalarMomentumMapLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="n">lam</span>
        <span class="sd">&quot;&quot;&quot;scalar momentum&quot;&quot;&quot;</span>

        <span class="n">cparams</span> <span class="o">=</span> <span class="n">params</span><span class="p">[(</span><span class="s1">&#39;forward_model&#39;</span><span class="p">,{},</span><span class="s1">&#39;settings for the forward model&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smoother</span> <span class="o">=</span> <span class="n">SF</span><span class="o">.</span><span class="n">SmootherFactory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">::],</span><span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span><span class="o">.</span><span class="n">create_smoother</span><span class="p">(</span><span class="n">cparams</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;smoother to go from momentum to velocity&quot;&quot;&quot;</span>

<div class="viewcode-block" id="LDDMMShootingScalarMomentumMapLoss.compute_regularization_energy"><a class="viewcode-back" href="../registration_networks.html#registration_networks.LDDMMShootingScalarMomentumMapLoss.compute_regularization_energy">[docs]</a>    <span class="k">def</span> <span class="nf">compute_regularization_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the regularizaton energy from the initial vector momentum as computed from the scalar momentum</span>
<span class="sd">        </span>
<span class="sd">        :param I0_source: initial image </span>
<span class="sd">        :return: returns the regularization energy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">compute_vector_momentum_from_scalar_momentum_multiNC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lam</span><span class="p">,</span> <span class="n">I0_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoother</span><span class="o">.</span><span class="n">smooth_vector_field_multiN</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">reg</span></div></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Marc Niethammer.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>